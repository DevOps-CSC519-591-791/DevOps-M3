---
- hosts: aws_server
  remote_user: ubuntu

  tasks:
    - name: install Redis server
      become: yes
      become_method: sudo
      apt: name=redis-server state=latest update_cache=yes

    - name: start redis server
      become: yes
      become_method: sudo
      command: redis-server --daemonize yes

    - name: check if Redis is running
      become: yes
      become_method: sudo
      service: name=redis-server state=started

    - name: enable redis-server to survive reboot
      become: yes
      become_method: sudo
      service: name=redis-server enabled=yes

    - name: flush all redis
      shell: echo 'flushall' | redis-cli

    - name: init the flag
      shell: echo 'set flag 11011' | redis-cli
    
    - name: init stable server set
      shell: echo 'sadd proxy http://54.164.22.224' | redis-cli

    - name: init alert set
      shell: echo 'set alert 0' | redis-cli

    - name: forever stop all services
      sudo: yes
      shell: forever stopall

    - name: load the balancer
      shell: cd /home/ubuntu/DevOps-M3/load_balancer && forever start balancer.js

    - name: load the selector
      shell: cd /home/ubuntu/DevOps-M3/flag_selector && forever start selector.js